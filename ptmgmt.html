<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Reviewing碳减排记录审查</title>
  <link rel="icon" href="/img/team.jpg" type="image/JPG">
  <!-- 引入Bootstrap和jQuery的CDN链接 -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <script src="./js/jquery.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>
  <script src="./js/nav.js"></script>
  <!-- 省略其他链接和样式 -->
  <style>
    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease; /* 添加过渡动画 */
      cursor: pointer;
    }

    .card:hover {
      transform: translateY(-5px); /* 鼠标悬停时上移 */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* 鼠标悬停时增加阴影 */
    }

    .card-img-top {
      height: 200px;
      object-fit: cover;
      border-top-left-radius: calc(0.25rem - 1px);
      border-top-right-radius: calc(0.25rem - 1px);
    }

    .card-body {
      padding: 15px;
      background-color: #ffffff;
      border-bottom-left-radius: calc(0.25rem - 1px);
      border-bottom-right-radius: calc(0.25rem - 1px);
    }

    .card-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .card-text {
      font-size: 14px;
      color: #666;
    }

    .card-text-row {
      padding: 0.5rem;
      margin: 0;
      background-color: #f9f9f9;
      border-bottom: 1px solid #eceeef;
    }

    .card-text-row:last-child {
      border-bottom: 0;
    }

    .auth-status {
      display: inline-block;
      padding: 0.25em 0.5em;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      text-align: center;
      width: 100%;
      margin-top: 10px;
    }

    .auth-yes {
      background-color: #28a745;
      color: black;
    }

    .auth-no {
      background-color: #dc3545;
      color: black;
    }

    .auth-non {
      background-color: #ffc107;
      color: black;
    }

    /* 设置背景颜色和字体 */
    body {
      background-color: #f0f0f0;
      font-family: "Microsoft YaHei", sans-serif;
    }

    /* 设置导航栏的样式 */
    .navbar {
      background-color: #007bff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand {
      color: white;
      font-weight: bold;
    }

    .navbar-nav .nav-link {
      color: white;
    }

    /* 设置轮播图的样式 */
    .carousel-item {
      height: 500px;
    }

    .carousel-item img {
      height: 100%;
      object-fit: cover;
    }

    /* 设置内容区域的样式 */
    .container {
      margin-top: 20px;
    }

    .card {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .card-img-top {
      height: 200px;
      object-fit: cover;
    }

    .card-body {
      padding: 15px;
    }

    .card-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .card-text {
      font-size: 14px;
      color: #666;
      height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 设置页脚的样式 */
    .footer {
      background-color: #f8f9fa;
      padding: 15px;
      text-align: center;
      color: #666;
      margin-top: 20px;
    }

    /* 设置登录模态框的样式 */
    .modal-header {
      border-bottom: none;
    }

    .modal-body {
      padding: 25px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-control {
      border-radius: 20px;
    }

    .btn-login {
      border-radius: 20px;
      background-color: #007bff;
      color: white;
    }

    .btn-login:hover {
      background-color: #0069d9;
    }

    .modal-footer {
      border-top: none;
      justify-content: center;
    }

    .modal-footer a {
      color: #007bff;
    }

    /* 添加自定义样式以突出显示前三名 */
    .rank-1 {
      background-color: #ffd700; /* 金色 */
    }

    .rank-2 {
      background-color: #c0c0c0; /* 银色 */
    }

    .rank-3 {
      background-color: #cd7f32; /* 铜色 */
    }

    .special-card .card-body {
      background-color: #eef9ff; /* 浅蓝色背景 */
      border-color: #b8deff; /* 边框颜色 */
    }

    .special-card .card-title {
      color: #007bff; /* 标题颜色 */
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-sm navbar-dark">

  <div class="container">
    <a class="navbar-brand" href="index.html">校园碳账户 |</a>
    <a class="navbar-brand" href="index.html">
      <img src="/img/team.png" alt="CarbonTrack校园碳账户" style="height: 100px;"></a>
    <a class="navbar-brand" href="index.html">CarbonTrack</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <span id="userStatus" class="navbar-text mr-3"></span>
        </li>
        <!--
                            <li class="nav-item">
                                <a class="nav-link" href="#">联系我们</a>
                            </li>-->
        <li class="nav-item">
          <a class="nav-link" href="#" data-toggle="modal" data-target="#registerModal">注册</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-toggle="modal" data-target="#loginModal">登录</a>
        </li>
        <li class="nav-item">
          <button id="logoutButton" class=" logoutControl btn btn-sm btn-danger" onclick="logout()"
                  style="display:none;">注销
          </button>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="index.html">首页</a>
        </li>
        <li class="nav-item">
          <a class="logoutControl nav-link " href="#" data-toggle="modal" data-target="#messagesModal"><i
              class="logoutControl fas fa-envelope" style="color: rgba(255, 255, 255, .5);font-size: 24px;"></i></a>
          <div class="badge-container">
            <span id="unreadMessagesCount" class="badge badge-danger" style="display: none;">0</span>
          </div>
        </li>
        <li class="nav-item">
          <a id="logoutButton logoutControl" class=" logoutControl nav-link" href="calculate.html">碳减排核算入口</a>
        </li>

        <li class="nav-item">
          <a id="logoutControl" class=" logoutControl nav-link" href="CStore.html">碳积分商城入口</a>
        </li>
        <li class="nav-item">
          <a id=" logoutControl" class="logoutControl nav-link" href="center.html">用户中心</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="about.html">关于我们</a>
        </li>

      </ul>
    </div>
  </div>
</nav>
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">用户登录</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="username">账号/用户名</label>
            <input type="text" class="form-control" id="username" placeholder="请输入用户名或邮箱地址">
          </div>
          <div class="form-group">
            <label for="password">密码</label>
            <input type="password" class="form-control" id="password" placeholder="请输入密码">
          </div>
          <button type="submit" class="btn btn-login btn-block">登录</button>
        </form>
      </div>
      <div class="modal-footer">
        <div class="alert alert-warning" role="alert" id="refreshAlert" style="display: none; cursor: pointer;">
          如果登录/注册失败，请尝试刷新页面或<a href="#" onclick="location.reload();">点此</a>以重新通过Cloudflare防火墙。
        </div>
        <a class="nav-link mr-right" href="iforgot.html">忘记密码?</a>
        <a class="nav-link" href="#" data-toggle="modal" data-target="#registerModal">注册账号</a>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="registerModalLabel">注册账户</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="username">用户名</label>
            <input type="text" class="form-control required-input" id="regusername" placeholder="请输入用户名">
          </div>
          <div class="form-group">
            <label for="password">密码</label>
            <input type="password" class="form-control required-input" id="regpassword" placeholder="请输入密码">
          </div>
          <div class="form-group">
            <label for="email">邮箱:</label>
            <input type="email" class="form-control required-input" id="email" name="email" required>
            <!-- 添加发送验证码按钮 -->
            <button type="button" class="btn btn-secondary" id="sendVerificationCode">发送验证码</button>
            <!-- 在注册模态框的表单中添加一个字段 -->
            <div class="form-group">
              <label for="verificationCode">验证码</label>
              <input type="text" class="form-control" id="verificationCode" placeholder="请输入验证码" required>
              <small id="emailHelp" class="form-text text-muted"
                     style="display: none;">我们已向您的邮箱发送了一个验证码。</small>
            </div>

          </div>
          <button type="submit" class="btn btn-login btn-block">注册</button>
          <div id="registerError" style="display:none;" class="alert alert-danger"></div>
        </form>
        <div class="modal-footer">
          <div class="alert alert-warning" role="alert" id="refreshAlert" style="display: none; cursor: pointer;">
            如果登录/注册失败，请尝试刷新页面或<a href="#" onclick="location.reload();">点此</a>以重新通过Cloudflare防火墙。
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 站内信模态框 -->
<div class="modal fade" id="messagesModal" tabindex="-1" role="dialog" aria-labelledby="messagesModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="messagesModalLabel">站内信</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-4" id="conversationList">
            <!-- 对话列表将在这里动态加载 -->
          </div>
          <div class="col-8">
            <div id="messageList" style="height: 400px; overflow-y: auto;">
              <!-- 消息列表将在这里动态加载 -->
            </div>
            <div class="input-group mt-3">
              <input type="text" class="form-control" id="messageInput" placeholder="输入消息...">
              <div class="input-group-append">
                <button class="btn btn-primary" type="button" id="sendMessage">发送</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>
<div class="container">
  <h3>碳减排记录审查</h3><br>
  <div id="records" class="row">
    <!-- 交易记录将在这里动态生成 -->
  </div>
</div>

<script>
  $(document).ready(function () {
    verifyAdmin()
  })
  var token = sessionStorage.getItem('token')
  if (token) {
  } else {

    alert('请先登录。')
    window.location.href = 'index.html'
  }

  function verifyAdmin() {
    var token = sessionStorage.getItem('token')
    $.ajax({
      type: 'POST',
      data: { token: token },
      url: 'verify_admin.php', // 替换为您的PHP脚本路径
      dataType: 'json',
      success: function (response) {
        if (response.success) {
          fetchTransactionsForAdmin()
        } else {
          alert('非法访问，您不是管理员。')
          window.location.href = 'index.html'
        }
      },
      error: function () {
        alert('验证失败，请重试。')
        window.location.href = 'index.html'
      },
    })
  }

  function fetchTransactionsForAdmin() {
    var token = sessionStorage.getItem('token')
    $.ajax({
      type: 'POST',
      data: { token: token },
      url: 'gapthis.php', // 替换为您的PHP脚本路径
      dataType: 'json',
      success: function (response) {
        if (response.success) {
          const recordsContainer = $('#records')
          recordsContainer.empty() // 清空现有记录
          // 过滤出act字段为'non'的记录
          const filteredRecords = response.data.filter(record => record.auth === 'non')
          if (filteredRecords.length === 0) {
            // 如果没有符合条件的记录，显示提示信息
            recordsContainer.append('<p>暂无要审批的数据。</p>')
          } else {
            // 处理过滤后的积分变动记录
            filteredRecords.forEach(record => {
              const card = createCard(record)
              recordsContainer.append(card)
            })
          }
        } else {
          // 处理错误消息
          alert('错误: ' + response.message)
        }
      },
      error: function () {
        alert('请求失败，请重试。')
      },
    })
  }


  function createCard(record) {
    const authClass = getAuthClass(record.auth)
    const authStatus = getAuthStatus(record.auth)
    // 检查记录的type字段，确定是普通记录还是特殊记录
    const cardTypeClass = record.type === 'spec' ? 'special-card' : ''

    return `
        <div class="col-md-4 ${cardTypeClass}">
            <div class="card mb-4">
                <img class="card-img-top" src="${record.img}" alt="User Image">
                <div class="card-body">
                    <h5 class="card-title">${record.username}</h5>
                    <div class="card-text-row">ID: ${record.id}</div>
                    <div class="card-text-row">UserID: ${record.uid}</div>
                    <div class="card-text-row">Email: ${record.email}</div>
                    <div class="card-text-row">Time: ${record.time}</div>
                    <div class="card-text-row">Points: ${record.points}</div>
                    <div class="card-text-row">Raw: ${record.raw}</div>
                    <div class="card-text-row">Activity: ${record.act}</div>
                    <div class="${authClass}">${authStatus}</div>
                    <button onclick="approveTransaction(${record.id}, '${record.type}','${record.uid}')" class="btn btn-success mx-2">通过</button>
                    <button onclick="rejectTransaction(${record.id}, '${record.type}')" class="btn btn-danger mx-2">打回</button>
                </div>
            </div>
        </div>
    `
  }


  function approveTransaction(id, type, uid) {
    $.ajax({
      type: 'POST',
      url: 'approve_transaction.php', // 替换为您的PHP脚本路径
      data: { token: token, transactionId: id, uid: uid, status: 'approved', type: type },
      dataType: 'json',
      success: function (response) {
        if (response.success) {
          alert('交易已通过。')
          // 刷新或更新页面上的记录
        } else {
          alert('审批失败: ' + response.message)
        }
      },
      error: function () {
        alert('请求失败，请重试。')
      },
    })
  }

  function rejectTransaction(id, type) {
    $.ajax({
      type: 'POST',
      url: 'reject_transaction.php', // 替换为您的PHP脚本路径
      data: { token: token, transactionId: id, status: 'rejected', type: type },
      dataType: 'json',
      success: function (response) {
        if (response.success) {
          alert('交易已打回。')
          // 刷新或更新页面上的记录
        } else {
          alert('打回失败: ' + response.message)
        }
      },
      error: function () {
        alert('请求失败，请重试。')
      },
    })
  }

  function getAuthClass(auth) {
    switch (auth) {
      case 'yes':
        return 'auth-yes'
      case 'no':
        return 'auth-no'
      default:
        return 'auth-non'
    }
  }

  function getAuthStatus(auth) {
    switch (auth) {
      case 'yes':
        return '已通过'
      case 'no':
        return '已打回'
      default:
        return '审批中'
    }
  }

</script>
<div id="footer-placeholder"></div>
<!-- 省略页脚 -->
</body>
</html>
