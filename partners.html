<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>CarbonTrack Contributor Network</title>
  <link rel="icon" href="/img/team.jpg" type="image/JPG">
  <!-- Bootstrap and jQuery -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <!-- SF Pro font -->
  <link href="https://fonts.cdnfonts.com/css/sf-pro-display" rel="stylesheet">
  <!-- Site CSS -->
  <link rel="stylesheet" href="./css/ios-design.css">
  <script src="js/utils.js"></script>
  <script src="js/nav.js"></script>
  <link rel="stylesheet" href="./css/index.css">
  <style>
    :root {
      /* Light mode colors */
      --text-color-light: #000;
      --text-color-dark: #fff;
      --bg-color-light: #f2f2f7;
      --bg-color-dark: #1c1c1e;
      --card-bg-light: #fff;
      --card-bg-dark: #2c2c2e;
      --border-color-light: #d1d1d6;
      --border-color-dark: #38383a;
      --muted-text-light: #8e8e93;
      --muted-text-dark: #aeaeb2;
      --map-bg-light: #3DA69A;
      --map-bg-dark: #2D7A71;
      --country-fill-light: #A1D1BF;
      --country-fill-dark: #5D8D7D;
      --marker-fill-light: #ff3b30;
      --marker-fill-dark: #ff453a;
      --animation-timing-apple: cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    
    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color-light);
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-color-light);
      transition: background-color 0.3s ease, color 0.3s ease;
      position: relative;
      min-height: 100vh;
    }

    /* Frosted glass background */
    .frosted-glass {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -2;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.05);
    }
    
    /* Add ambient glow effects */
    .glow-effect {
      position: fixed;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      filter: blur(50px);
      z-index: -1;
      opacity: 0.5;
      animation: pulse 8s infinite alternate var(--animation-timing-apple);
    }
    
    .glow-green {
      top: 10%;
      right: 10%;
      background: radial-gradient(circle, rgba(52, 199, 89, 0.2), transparent 70%);
    }
    
    .glow-blue {
      bottom: 10%;
      left: 5%;
      background: radial-gradient(circle, rgba(0, 122, 255, 0.15), transparent 70%);
      animation-delay: 2s;
    }
    
    @keyframes pulse {
      0% { transform: scale(1) translate(0, 0); opacity: 0.5; }
      50% { transform: scale(1.05) translate(20px, -10px); opacity: 0.7; }
      100% { transform: scale(1) translate(0, 0); opacity: 0.5; }
    }

    /* Dark mode styles */
    body.dark-theme,
    body.auto-theme.dark-mode {
      background-color: var(--bg-color-dark);
      color: var(--text-color-dark);
    }

    .block {
      background-color: var(--card-bg-light);
      border-radius: 24px;
      max-width: 1000px;
      margin: 30px auto;
      padding: 30px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.4s var(--animation-timing-apple);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    .block:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
    }

    body.dark-theme .block,
    body.auto-theme.dark-mode .block {
      background-color: var(--card-bg-dark);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .hero-header {
      background: linear-gradient(135deg, var(--ios-green), var(--ios-mint));
      color: white;
      padding: 120px 0 80px;
      text-align: center;
      border-radius: 0 0 24px 24px;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
    }
    
    /* Add shimmer effect */
    .hero-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
      transform: rotate(30deg);
      animation: shimmer 10s infinite linear;
      pointer-events: none;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-50%) rotate(0deg); }
      100% { transform: translateX(0%) rotate(360deg); }
    }
    
    .hero-header h1 {
      font-weight: 700;
      color: white;
      margin-bottom: 16px;
      font-size: 48px;
      opacity: 0;
      animation: fadeInUp 0.8s var(--animation-timing-apple) forwards;
    }
    
    .hero-header p {
      font-size: 1.2rem;
      opacity: 0;
      max-width: 800px;
      margin: 0 auto;
      animation: fadeInUp 0.8s var(--animation-timing-apple) 0.2s forwards;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #header {
      text-align: center;
    }
    
    #header h1 {
      margin: 0;
      font-size: 42px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--ios-green), var(--ios-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      opacity: 0;
      animation: fadeInUp 0.8s var(--animation-timing-apple) 0.4s forwards;
    }
    
    #header h2 {
      margin: 20px 0 10px;
      font-size: 24px;
      font-weight: 600;
      color: var(--text-color-light);
      opacity: 0;
      animation: fadeInUp 0.8s var(--animation-timing-apple) 0.6s forwards;
    }
    
    body.dark-theme #header h2,
    body.auto-theme.dark-mode #header h2 {
      color: var(--text-color-dark);
    }
    
    #header p, #footer p {
      max-width: 800px;
      margin: 16px auto;
      line-height: 1.6;
      font-size: 18px;
      color: var(--text-color-light);
      opacity: 0;
      animation: fadeInUp 0.8s var(--animation-timing-apple) 0.8s forwards;
    }
    
    body.dark-theme #header p,
    body.auto-theme.dark-mode #header p,
    body.dark-theme #footer p,
    body.auto-theme.dark-mode #footer p {
      color: var(--text-color-dark);
    }
    
    #header h3 {
      margin: 30px 0 10px;
      font-size: 24px;
      font-weight: 600;
      color: var(--text-color-light);
      opacity: 0;
      animation: fadeInUp 0.8s var(--animation-timing-apple) 1s forwards;
    }
    
    body.dark-theme #header h3,
    body.auto-theme.dark-mode #header h3 {
      color: var(--text-color-dark);
    }

    #map-container {
      width: 100%;
      height: 70vh;
      position: relative;
      overflow: hidden;
      background: var(--map-bg-light);
      border-radius: 24px;
      transition: background-color 0.3s ease, transform 0.4s var(--animation-timing-apple);
      opacity: 0;
      animation: fadeInUp 0.8s var(--animation-timing-apple) 1.2s forwards;
    }
    
    body.dark-theme #map-container,
    body.auto-theme.dark-mode #map-container {
      background: var(--map-bg-dark);
    }
    
    svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .country {
      fill: var(--country-fill-light);
      stroke: rgba(255, 255, 255, 0.2);
      stroke-width: 0.5;
      transition: fill 0.3s ease;
    }
    
    body.dark-theme .country,
    body.auto-theme.dark-mode .country {
      fill: var(--country-fill-dark);
    }

    .marker {
      fill: var(--marker-fill-light);
      cursor: pointer;
      transition: fill 0.3s ease, transform 0.2s ease;
      transform-origin: center center;
    }
    
    body.dark-theme .marker,
    body.auto-theme.dark-mode .marker {
      fill: var(--marker-fill-dark);
    }
    
    .marker:hover {
      fill: var(--ios-blue);
      /* Remove the transform to prevent flickering */
      /* transform: scale(1.2); */
    }

    #popup {
      position: absolute;
      background: var(--card-bg-light);
      border: 1px solid var(--border-color-light);
      border-radius: 16px;
      padding: 16px;
      max-width: 300px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 10;
      animation: bounce 0.4s ease-out;
      pointer-events: auto;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      transform-origin: center bottom;
      will-change: transform;
      overflow: auto;
      max-height: 60vh;
    }
    
    body.dark-theme #popup,
    body.auto-theme.dark-mode #popup {
      background: var(--card-bg-dark);
      border-color: var(--border-color-dark);
    }
    
    @keyframes bounce {
      0% { transform: translateY(-20px) scale(0.8); opacity: 0; }
      60% { transform: translateY(5px) scale(1.02); opacity: 1; }
      100% { transform: translateY(0) scale(1); }
    }
    
    #popup h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-color-light);
    }
    
    body.dark-theme #popup h3,
    body.auto-theme.dark-mode #popup h3 {
      color: var(--text-color-dark);
    }
    
    #popup p, #popup li {
      margin: 0 0 8px 0;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-color-light);
    }
    
    body.dark-theme #popup p,
    body.auto-theme.dark-mode #popup p,
    body.dark-theme #popup li,
    body.auto-theme.dark-mode #popup li {
      color: var(--text-color-dark);
    }
    
    #popup ul {
      padding-left: 20px;
      margin: 10px 0;
    }
    
    #popup strong {
      font-weight: 600;
      color: var(--ios-blue);
    }
    
    #footer {
      text-align: center;
      padding: 20px;
      opacity: 0;
      animation: fadeInUp 0.8s var(--animation-timing-apple) 1.4s forwards;
    }
    
    #footer h3 {
      margin: 0 0 16px 0;
      font-size: 28px;
      font-weight: 600;
      color: var(--text-color-light);
    }
    
    body.dark-theme #footer h3,
    body.auto-theme.dark-mode #footer h3 {
      color: var(--text-color-dark);
    }
    
    .join-button {
      display: inline-block;
      background: linear-gradient(135deg, var(--ios-green), var(--ios-mint));
      color: white;
      font-weight: 600;
      padding: 14px 32px;
      border-radius: 50px;
      text-decoration: none;
      margin-top: 16px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
    }
    
    .join-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 199, 89, 0.4);
      color: white;
      text-decoration: none;
    }
    
    /* Theme toggle button */
    .theme-toggle {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 48px;
      height: 48px;
      border-radius: 24px;
      background-color: #f2f2f7;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    body.dark-theme .theme-toggle,
    body.auto-theme.dark-mode .theme-toggle {
      background-color: #3a3a3c;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .theme-toggle i {
      font-size: 22px;
      color: #8e8e93;
      transition: color 0.3s ease;
    }

    body.dark-theme .theme-toggle i,
    body.auto-theme.dark-mode .theme-toggle i {
      color: #fff;
    }
    
    /* Responsive styles */
    @media (max-width: 768px) {
      .hero-header {
        padding: 100px 0 60px;
      }
      
      .hero-header h1 {
        font-size: 36px;
      }
      
      #header h1 {
        font-size: 32px;
      }
      
      #header h2, #header h3 {
        font-size: 20px;
      }
      
      #header p, #footer p {
        font-size: 16px;
        padding: 0 15px;
      }
      
      #map-container {
        height: 50vh;
      }
      
      .block {
        margin: 20px 15px;
        padding: 20px;
      }
    }

    /* Custom scrollbar for popup */
    #popup::-webkit-scrollbar {
      width: 8px;
    }
    
    #popup::-webkit-scrollbar-track {
      background: transparent; /* Match popup background */
    }
    
    #popup::-webkit-scrollbar-thumb {
      background-color: rgba(142, 142, 147, 0.5); /* System gray */
      border-radius: 4px;
    }
    
    body.dark-theme #popup::-webkit-scrollbar-thumb,
    body.auto-theme.dark-mode #popup::-webkit-scrollbar-thumb {
      background-color: rgba(99, 99, 102, 0.7); /* Darker gray for dark mode */
    }
  </style>
  <script>
    // To be executed after the page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Theme toggle functionality
      // Check if user has a saved preference
      const savedTheme = localStorage.getItem('theme');
      const body = document.body;
      
      if (savedTheme) {
        body.className = savedTheme;
        updateThemeIcon(savedTheme);
      } else {
        body.classList.add('auto-theme');
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          body.classList.add('dark-mode');
        }
        updateThemeIcon('auto-theme');
      }
      
      // Listen for system dark mode changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
        if (body.classList.contains('auto-theme')) {
          if (e.matches) {
            body.classList.add('dark-mode');
          } else {
            body.classList.remove('dark-mode');
          }
          updateThemeIcon('auto-theme');
        }
      });
      
      // Create theme toggle button
      const themeToggle = document.createElement('div');
      themeToggle.className = 'theme-toggle';
      themeToggle.id = 'themeToggle';
      themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      document.body.appendChild(themeToggle);
      
      // Add click event to theme toggle
      themeToggle.addEventListener('click', function() {
        if (body.classList.contains('auto-theme')) {
          body.classList.remove('auto-theme');
          body.classList.remove('dark-mode');
          body.classList.add('dark-theme');
          localStorage.setItem('theme', 'dark-theme');
        } else if (body.classList.contains('dark-theme')) {
          body.classList.remove('dark-theme');
          body.classList.add('light-theme');
          localStorage.setItem('theme', 'light-theme');
        } else {
          body.classList.remove('light-theme');
          body.classList.add('auto-theme');
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            body.classList.add('dark-mode');
          }
          localStorage.setItem('theme', 'auto-theme');
        }
        updateThemeIcon(body.className);
      });
      
      function updateThemeIcon(theme) {
        const icon = document.querySelector('#themeToggle i');
        if (!icon) return;
        
        if (theme.includes('dark-theme')) {
          icon.className = 'fas fa-sun';
        } else if (theme.includes('light-theme')) {
          icon.className = 'fas fa-moon';
        } else {
          // Auto theme
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            icon.className = 'fas fa-sun';
          } else {
            icon.className = 'fas fa-moon';
          }
        }
      }
      
      // 全局点击事件监听器，用于关闭地图弹窗
      document.addEventListener('click', function(event) {
        const mapContainer = document.getElementById('map-container');
        const popup = document.getElementById('popup');
        
        // 如果点击的不是地图容器内的元素且弹窗可见，则隐藏弹窗
        if (popup && popup.style.display === 'block' && !mapContainer.contains(event.target)) {
          popup.style.display = 'none';
          isPopupSticky = false; // Reset sticky state when closing popup
          // 重置活动标记
          if (window.activeMarker) {
            window.activeMarker = null;
          }
        }
      });
    });
  </script>
</head>
<body class="auto-theme">
  <!-- Add frosted glass background -->
  <div class="frosted-glass"></div>

  <!-- Add ambient glow effects -->
  <div class="glow-effect glow-green"></div>
  <div class="glow-effect glow-blue"></div>

  <!-- Navbar container, will be loaded by JavaScript -->
  <div id="navbar-container"></div>

  <!-- Hero Header -->
  <header class="hero-header">
    <div class="container">
      <h1>CarbonTrack Contributor Network</h1>
      <p>Global Youth, Creating a Sustainable Future Together</p>
    </div>
  </header>

  <div class="container">
    <div id="header" class="block">
      <h1>CarbonTrack Contributor Network 🌎</h1>
      <h2>Global Youth, Creating a Sustainable Future Together</h2>
      <p>
        CarbonTrack is empowering environmentally conscious youth from around the world.
        We cultivate a common drive across schools and communities, using CarbonTrack to track their carbon footprint,
        promote sustainable living styles, and drive real impact in their surroundings.
      </p>
      <h3>Where Our Contributors Are From</h3>
      <p>
        On this map, you can see the schools and communities our contributors come from.
        They actively promote sustainability within their campuses and engage in various initiatives
        within the CarbonTrack community.
      </p>
    </div>

    <div id="map-container" class="block">
      <svg id="map"></svg>
      <div id="popup"></div>
    </div>

    <div id="footer" class="block">
      <h3>Join Our Global Movement</h3>
      <p>
        If you're passionate about sustainability and want to be part of a global network of changemakers,
        we welcome you to join us! Together, we can create a more sustainable future for our planet.
      </p>
      <a href="about.html" class="join-button">Join Us Today</a>
    </div>
  </div>

  <!-- Footer placeholder -->
  <div id="footer-placeholder"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const container = document.getElementById("map-container");
    const width = container.clientWidth;
    const height = container.clientHeight;
    const svg = d3.select("#map");
    const mapGroup = svg.append("g");

    const projection = d3.geoEquirectangular();
    const path = d3.geoPath(projection);
    const horizontalFactor = 0.65;
    const effectiveWidth = width * horizontalFactor;

    let isPopupSticky = false; // Track if popup should stay open
    let hidePopupTimeout; // Timeout to hide popup with delay
    
    // Mouse is over popup flag
    let isMouseOverPopup = false;

    const schools = [
    {
        name: "Hamden Hall Country Day School",
        coords: [-72.93, 41.40],
        info: "Adress: 1108 Whitney Ave, Hamden, Ct, 06516. It is the founding place of the Carbon Footprint Initiative."
      },
      {
        name: "Kingswood Oxford School",
        coords: [-72.75, 41.78],
        info: "Adress: 170 Kingswood Rd, West Hartford, CT 06119. Its material club is one of our major collaborators."
      },
      {
        name: "Nanjing Foreign Language School",
        coords: [118.78, 32.05],
        info: "Adress: 30 Beijing E Rd, Xuanwu, Nanjing, Jiangsu. One of the founding places of the Carbon Footprint Initiative."
      },
      {
        name: "Shanghai Starriver Bilingual School",
        coords: [121.2, 31.2],
        info: "Adress: 上海市闵行区金都路2588号. A bilingual School in Shanghai, China, with a profound focus on sustainability, one of the participants of our Initiative."
      },
      {
        name: "Baylor School",
        coords: [-85.3, 35.08],
        info: "Adress: 171 Baylor School Rd, Chattanooga, TN, 37405. It has a strong focus on sustainability and environmental education, one of the participants of our Initiative."
      },
      {
        name: "Hiba Academy shanghai",
        coords: [121.2, 31.4],
        info: "Adress: 上海市浦东新区林耀路235号. A bilingual School in Shanghai, China, with a profound focus on sustainability, one of the participants of our Initiative"
      },
      {
        name: "Shanghai Qingpu Pinghe Bilingual School",
        coords: [121.4, 31.1],
        info: "Adress: 上海市青浦区朱家角路6号. A bilingual School in Shanghai, China, with a profound focus on sustainability, one of the participants of our Initiative"
      },
      {
        name: "The Bryn Mawr School",
        coords: [-76.63, 39.37],
        info: "Adress: 109 W Melrose Ave, Baltimore, MD 21210. It has a great focus on sustainability and environmental education, one of the participants of our Initiative"
      },
      {
        name: "上海市世界外国语中学",
        coords: [121.4, 31.2],
        info: "Adress: 中国上海市虹漕南路602号. An international School in Shanghai, China, with a profound focus on sustainability, one of the first participants of our Initiative"
      },
      {
        name: "广东碧桂园学校",
        coords: [113.16, 22.56],
        info: "Adress: Shunde District, Foshan, China, 511419. An international School in Guangdong, China, with a profound focus on sustainability, one of the participants of our Initiative"
      }
    ];

    // Popup functions with smooth bounce animation
    const popup = d3.select("#popup");
    function showPopup(event, htmlContent) {
      // Use d3.pointer for coordinates relative to the map container
      const [x, y] = d3.pointer(event, container);
      
      popup.html(htmlContent);

      // Get popup dimensions after setting content but before displaying
      popup.style("display", "block")
           .style("visibility", "hidden"); // Temporarily hide while calculating position
      
      const popupWidth = popup.node().offsetWidth;
      const popupHeight = popup.node().offsetHeight;
      const mapRect = container.getBoundingClientRect();

      // Calculate position to avoid edge overflow
      let left = x + 15;
      let top = y - 15;
      
      // Special positioning for east Asia region (China markers)
      // Check if marker is in the right side of the map
      if (x > mapRect.width * 0.75) {
        // Force display to the left for right-side markers
        left = x - popupWidth - 15;
      } else if (left + popupWidth > mapRect.width) {
        // For other markers, adjust if would overflow right edge
        left = x - popupWidth - 15; 
      }
      
      // Adjust if would overflow bottom edge
      if (top + popupHeight > mapRect.height) {
          top = Math.max(5, mapRect.height - popupHeight - 10); // Keep within map with small margin
      }
      
      // Adjust if would overflow top edge
      if (top < 5) {
          top = 5; // Maintain small margin from top
      }

      // Apply final position and make visible
      popup.style("left", left + "px")
           .style("top", top + "px")
           .style("visibility", "visible");
    }
    function hidePopup() {
      popup.style("display", "none")
           .style("visibility", "hidden");
    }

    // Add event listeners to popup for mouse enter/leave
    popup.on("mouseenter", function() {
      isMouseOverPopup = true;
      // Clear any pending hide timeouts
      if (hidePopupTimeout) {
        clearTimeout(hidePopupTimeout);
        hidePopupTimeout = null;
      }
    }).on("mouseleave", function() {
      isMouseOverPopup = false;
      // Only hide if not sticky
      if (!isPopupSticky) {
        hidePopup();
      }
    });

    const markerSymbol = d3.symbol().type(d3.symbolCircle).size(120);

    function markerMouseEnter(event, d) {
      event.stopPropagation();
      
      // Calculate cluster info
      const [baseX, baseY] = projection(d.coords);
      const cluster = [];
      mapGroup.selectAll(".marker").each(function(d2) {
        // Skip self comparison
        if (d === d2) return;
        const [bx, by] = projection(d2.coords);
        const dx = bx - baseX, dy = by - baseY;
        // Increase distance threshold for cluster detection
        if (Math.sqrt(dx * dx + dy * dy) < 40) { 
          cluster.push(d2);
        }
      });
      
      // Generate HTML content
      let htmlContent;
      // Combine hovered marker + cluster
      const displayItems = [d].concat(cluster);
      
      if (displayItems.length > 1) {
        htmlContent = "<h3>Schools in this area:</h3><ul>";
        displayItems.forEach(school => {
           htmlContent += `<li><strong>${school.name}</strong><br>${school.info}</li>`;
        });
        htmlContent += "</ul>";
      } else {
        // Only the single hovered marker
        htmlContent = `<h3>${d.name}</h3><p>${d.info}</p>`;
      }
      
      // Show popup directly using event coordinates relative to container
      showPopup(event, htmlContent);
    }
    
    function markerMouseLeave(event, d) {
      event.stopPropagation();
      // Hide popup only if it's not sticky (i.e., not clicked),
      // and use a timeout to allow moving to the popup
      if (!isPopupSticky) {
        // Clear any existing timeout
        if (hidePopupTimeout) {
          clearTimeout(hidePopupTimeout);
        }
        
        // Set a short delay to check if mouse moved to popup
        hidePopupTimeout = setTimeout(() => {
          if (!isMouseOverPopup) {
            hidePopup();
          }
        }, 300); // 300ms delay
      }
    }

    // Click handling can remain similar
    function markerClick(event, d) {
      event.stopPropagation();
      markerMouseEnter(event, d); // Reuse mouseenter logic for click
      isPopupSticky = true; // Mark popup as sticky after click
      
      // Optional: close popup on clicking outside the map
      // d3.select(document).on("click.popup", function(e) {
      //   if (!container.contains(e.target)) {
      //     activeMarker = null;
      //     hidePopup();
      //     d3.select(document).on("click.popup", null); // Remove listener
      //   }
      // });
    }

    d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
      .then(world => {
        const worldData = world.features.filter(d => d.properties.name !== "Antarctica");
        const worldFC = { type: "FeatureCollection", features: worldData };
        projection.fitSize([effectiveWidth, height], worldFC);
        projection.scale(projection.scale() * 1.3);
        const offsetX = (width - effectiveWidth) / 2;
        mapGroup.attr("transform", `translate(${offsetX}, 0)`);
        mapGroup.selectAll("path.country")
          .data(worldData)
          .enter()
          .append("path")
          .attr("class", "country")
          .attr("d", path);
        mapGroup.selectAll("path.marker")
          .data(schools)
          .enter()
          .append("path")
          .attr("class", "marker")
          .attr("transform", d => {
            const [mx, my] = projection(d.coords);
            return `translate(${mx}, ${my})`;
          })
          .attr("d", markerSymbol)
          .on("mouseenter", markerMouseEnter) // Changed event
          .on("mouseleave", markerMouseLeave) // Add mouseleave listener back
          .on("click", markerClick); // Keep click handling
      });
  </script>
</body>
</html>