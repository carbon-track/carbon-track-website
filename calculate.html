<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Accounting Portal - CarbonTrack</title>
  <link rel="icon" href="/img/team.jpg" type="image/JPG">
  <!-- 引入Bootstrap和jQuery的CDN链接 -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <!-- SF Pro font -->
  <link href="https://fonts.cdnfonts.com/css/sf-pro-display" rel="stylesheet">
  <!-- Intersection Observer polyfill for older browsers -->
  <script src="https://cdn.jsdelivr.net/npm/intersection-observer@0.12.2/intersection-observer.js"></script>
  <!-- iOS设计CSS -->
  <link rel="stylesheet" href="./css/ios-design.css">
  <script src="js/nav.js"></script>
  <link rel="stylesheet" href="./css/index.css">
  <style>
    .calc-header {
      background: linear-gradient(135deg, var(--ios-green), var(--ios-mint));
      color: white;
      padding: 120px 0 80px;
      text-align: center;
      border-radius: 0 0 24px 24px;
      margin-bottom: 40px;
    }
    
    .calc-header h1 {
      font-weight: 700;
      color: white;
      margin-bottom: 16px;
    }
    
    .calc-header p {
      font-size: 1.2rem;
      opacity: 0.9;
      max-width: 700px;
      margin: 0 auto;
    }
    
    .calculator-card {
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      background-color: var(--ios-system-background);
      margin-bottom: 30px;
    }
    
    .calculator-header {
      background-color: var(--ios-gray6);
      padding: 20px 24px;
      border-bottom: 1px solid var(--ios-gray5);
    }
    
    .calculator-header h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
    }
    
    .calculator-body {
      padding: 24px;
    }
    
    .result-card {
      background: linear-gradient(135deg, var(--ios-blue), var(--ios-indigo));
      color: white;
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      margin-top: 24px;
    }
    
    .result-card h3 {
      color: white;
      margin-bottom: 16px;
      font-weight: 700;
    }
    
    .result-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .result-unit {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .activity-card {
      background-color: var(--ios-gray6);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--ios-gray5);
    }
    
    .activity-card h4 {
      font-weight: 600;
      margin-bottom: 16px;
    }
  </style>
  <script>
    $(document).ready(function () {
      var token = localStorage.getItem('token')
      if (token) {
        // 用户已登录
      } else {
        $('#userPoints').text('未登录')
        alert('请先登录。')
        window.location.href = 'index.html'
      }
      // 初始化活动小类选项
      updateActivityOptions($('#category').val())
      calculateAndDisplayReduction() // 确保活动选项已填充
      $('#dataInput, #activity').on('input change', calculateAndDisplayReduction)
      $('#carbonForm').submit(function (e) {
        e.preventDefault()
        
        // 检查是否有上传照片
        var imageFile = $('#imageUpload')[0].files[0];
        if (!imageFile) {
          $('#submissionResult').html('<div class="alert alert-danger">请上传照片作为证明！</div>');
          return false;
        }
        
        var formData = new FormData(this)
        formData.append('activity', $('#activity').val())
        formData.append('oridata', $('#dataInput').val())
        formData.append('token', localStorage.getItem('token'))
        formData.append('id', localStorage.getItem('id'))

        // 显示加载状态
        $('#submitButton').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 提交中...');
        
        $.ajax({
          type: 'POST',
          url: 'calculate.php',
          data: formData,
          processData: false,
          contentType: false,
          dataType: 'json',
          success: function (response) {
            // 恢复按钮状态
            $('#submitButton').prop('disabled', false).html('Submit Carbon Reduction');
            
            if (response.success === true) {
              // 提交成功，更新用户积分
              console.log('Carbon footprint recorded successfully. Carbon reduction: ' + response.points)
              $('#submissionResult').html('<div class="alert alert-success">Success! ' + response.points + ' points recorded!</div>')
              getUserPoints() // 更新用户积分显示
              
              // 清空表单
              $('#carbonForm')[0].reset();
              $('#imagePreview').attr('src', '').hide();
              
              // 重新初始化选项
              updateActivityOptions($('#category').val());
            } else {
              // 提交失败，显示错误消息
              console.error('Error recording carbon footprint:', response.message)
              $('#submissionResult').html('<div class="alert alert-danger">Error: ' + response.message + '</div>')
            }
          },
          error: function () {
            // 恢复按钮状态
            $('#submitButton').prop('disabled', false).html('Submit Carbon Reduction');
            
            console.error('AJAX请求失败')
            $('#submissionResult').html('<div class="alert alert-danger">AJAX request failed.</div>')
          }
        })
      })

      // 活动大类改变时更新活动小类选项
      $('#category').change(function () {
        updateActivityOptions($(this).val())
      })

      // 获取用户积分
      getUserPoints()
      
      // 图片预览功能
      $('#imageUpload').change(function() {
        var file = this.files[0];
        if (file) {
          var reader = new FileReader();
          reader.onload = function(e) {
            $('#imagePreview').attr('src', e.target.result).show();
          }
          reader.readAsDataURL(file);
        }
      });
    })

    // 更新活动小类选项的函数
    function updateActivityOptions(category) {
      // 清空当前选项
      $('#activity').empty()

      // 根据不同的活动大类添加相应的活动小类选项
      switch (category) {
        case 'transport':
          addOption('公交出行1km / Bus transport 1km', '公交出行1km / Bus transport 1km')
          addOption('地铁出行1km / Subway travel 1km', '地铁出行1km / Subway travel 1km')
          addOption('步行1km / Walk 1km', '步行1km / Walk 1km')
          addOption('骑行1km / Cycle 1km', '骑行1km / Cycle 1km')
          addOption('拼车1km / Carpool 1km', '拼车1km / Carpool 1km')
          break
        case 'energy':
          addOption('上网课1h / Online class 1h', '上网课1h / Online class 1h')
          addOption('提交电子作业1次 / Write assignment electronically 1 time', '提交电子作业1次 / Write assignment electronically 1 time')
          break
        case 'food':
          addOption('减少肉类消费1kg / Reduce meat consumption 1kg', '减少肉类消费1kg / Reduce meat consumption 1kg')
          addOption('光盘行动1次 / Finish everything on your plate 1 time', '光盘行动1次 / Finish everything on your plate 1 time')
          break
        case 'waste':
          addOption('旧衣回收1kg / Recycle 1kg old clothes', '旧衣回收1kg / Recycle 1kg old clothes')
          addOption('二手交易1次 / Second-hand transaction 1 time', '二手交易1次 / Second-hand transaction 1 time')
          addOption('衣物租赁1次 / Clothing rental service 1 time', '衣物租赁1次 / Clothing rental service 1 time')
          addOption('居家回收利用', '居家回收利用')
          break
      }

      // 触发计算和显示减排量
      calculateAndDisplayReduction()
    }

    // 添加选项的辅助函数
    function addOption(value, text) {
      $('#activity').append($('<option></option>').val(value).text(text))
    }

    // 计算并显示减排量的函数
    function calculateAndDisplayReduction() {
      var activity = $('#activity').val()
      var dataInput = parseFloat($('#dataInput').val()) || 0

      // 减排系数（kg CO2 per unit）
      var reductionFactors = {
        '旧衣回收1kg / Recycle 1kg old clothes': 3.6,
        '二手交易1次 / Second-hand transaction 1 time': 10, // 基础分值 + 4
        '衣物租赁1次 / Clothing rental service 1 time': 10, // 基础分值 + 4
        '减少肉类消费1kg / Reduce meat consumption 1kg': 15.54,
        '光盘行动1次 / Finish everything on your plate 1 time': 0.0329041095890411,
        '居家回收利用': 10, // 基础分值 + 4
        '公交出行1km / Bus transport 1km': 0.094,
        '地铁出行1km / Subway travel 1km': 0.089,
        '步行1km / Walk 1km': 0.135,
        '骑行1km / Cycle 1km': 0.05,
        '拼车1km / Carpool 1km': 0.0675,
        '上网课1h / Online class 1h': 0.15,
        '提交电子作业1次 / Write assignment electronically 1 time': 0.05
      }

      // 单位标签
      var unitLabels = {
        '旧衣回收1kg / Recycle 1kg old clothes': 'kg',
        '二手交易1次 / Second-hand transaction 1 time': '次',
        '衣物租赁1次 / Clothing rental service 1 time': '次',
        '减少肉类消费1kg / Reduce meat consumption 1kg': 'kg',
        '光盘行动1次 / Finish everything on your plate 1 time': '次',
        '居家回收利用': '次',
        '公交出行1km / Bus transport 1km': 'km',
        '地铁出行1km / Subway travel 1km': 'km',
        '步行1km / Walk 1km': 'km',
        '骑行1km / Cycle 1km': 'km',
        '拼车1km / Carpool 1km': 'km',
        '上网课1h / Online class 1h': 'h',
        '提交电子作业1次 / Write assignment electronically 1 time': '次'
      }

      // 自定义计算逻辑（针对带有额外加分的活动）
      var carbonSavings = 0;
      if (activity === '二手交易1次 / Second-hand transaction 1 time' || 
          activity === '衣物租赁1次 / Clothing rental service 1 time' || 
          activity === '居家回收利用') {
        carbonSavings = dataInput * reductionFactors[activity] + 4;
      } else {
        carbonSavings = dataInput * reductionFactors[activity];
      }

      // 显示减排量和单位
      $('#unitLabel').text(unitLabels[activity] || 'units')
      $('#reductionAmount').text(carbonSavings.toFixed(2))
    }

    // 获取用户积分的函数
    function getUserPoints() {
      var token = localStorage.getItem('token')

      // 发送AJAX请求获取用户积分
      $.ajax({
        type: 'POST',
        url: 'get_user_points.php',
        data: {
          token: token
        },
        dataType: 'json',
        success: function (response) {
          if (response.success) {
            $('#userPoints').text(response.userPoints)
          } else {
            console.error('Error getting user points:', response.message)
          }
        },
        error: function () {
          console.error('AJAX请求失败')
        }
      })
    }
  </script>
</head>
<body>
<!-- 导航栏容器，将由JavaScript加载 -->
<div id="navbar-container"></div>

<header class="calc-header">
  <div class="container">
    <h1>Carbon Accounting Portal</h1>
    <p>Record your sustainable actions and track your positive impact on the environment. Every small action counts towards a greener future.</p>
  </div>
</header>

<div class="container">
  <div class="row">
    <div class="col-md-8">
      <div class="calculator-card frosted-glass ios-depth-effect">
        <div class="calculator-header">
          <h2>Carbon Reduction Calculator</h2>
        </div>
        <div class="calculator-body">
          <form id="carbonForm" method="post" enctype="multipart/form-data">
            <div class="form-group">
              <label for="category">Category</label>
              <select class="form-control" id="category" name="category">
                <option value="transport">Transportation</option>
                <option value="energy">Energy Saving</option>
                <option value="food">Food Choices</option>
                <option value="waste">Waste Management</option>
              </select>
            </div>
            <div class="form-group">
              <label for="activity">Activity</label>
              <select class="form-control" id="activity" name="activity">
                <!-- 将由JavaScript动态填充 -->
              </select>
            </div>
            <div class="form-group">
              <label for="dataInput">Quantity <span id="unitLabel">units</span></label>
              <input type="number" class="form-control" id="dataInput" name="data" placeholder="Enter amount" min="0.1" step="0.1" required>
            </div>
            <div class="form-group">
              <label for="date">Date</label>
              <input type="date" class="form-control" id="date" name="date" value="" required>
              <script>document.getElementById('date').valueAsDate = new Date()</script>
            </div>
            <div class="form-group">
              <label for="imageUpload">Upload Photo Evidence</label>
              <input type="file" class="form-control-file" id="imageUpload" name="image" accept="image/*" required>
              <small class="form-text text-muted">Please upload a photo as evidence of your activity (max 5MB).</small>
              <div class="mt-2">
                <img id="imagePreview" src="" alt="Image Preview" style="max-width:100%; max-height:200px; display:none;">
              </div>
            </div>
            <div class="form-group">
              <label for="notes">Notes (Optional)</label>
              <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Add any additional notes here"></textarea>
            </div>
            <button type="submit" id="submitButton" class="btn btn-ios-primary btn-block">Submit Carbon Reduction</button>
          </form>
          <div id="submissionResult" class="mt-3"></div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="result-card ios-hover-effect">
        <h3>Your Estimated Carbon Reduction</h3>
        <div class="result-value"><span id="reductionAmount">0.00</span></div>
        <p class="result-unit">kg CO₂ equivalent</p>
      </div>
      
      <div class="calculator-card mt-4">
        <div class="calculator-header">
          <h2>Your Account</h2>
        </div>
        <div class="calculator-body">
          <p><strong>Total Carbon Credits:</strong> <span id="userPoints">Loading...</span></p>
          <a href="center.html" class="btn btn-outline-primary btn-block">View Account History</a>
        </div>
      </div>
      
      <div class="activity-card mt-4">
        <h4>Environmental Impact</h4>
        <p>Every action you record helps reduce carbon emissions and contributes to a more sustainable future. Track your progress and see the difference you're making!</p>
      </div>
    </div>
  </div>
</div>

<!-- 页脚 -->
<div id="footer-placeholder"></div>
</body>
</html>
