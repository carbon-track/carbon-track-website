<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Accounting Portal - CarbonTrack</title>
  <link rel="icon" href="/img/team.jpg" type="image/JPG">
  <!-- 引入Bootstrap和jQuery的CDN链接 -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <!-- SF Pro font -->
  <link href="https://fonts.cdnfonts.com/css/sf-pro-display" rel="stylesheet">
  <!-- Intersection Observer polyfill for older browsers -->
  <script src="https://cdn.jsdelivr.net/npm/intersection-observer@0.12.2/intersection-observer.js"></script>
  <!-- iOS设计CSS -->
  <link rel="stylesheet" href="./css/ios-design.css">
  <script src="js/nav.js"></script>
  <link rel="stylesheet" href="./css/index.css">
  <style>
    .calc-header {
      background: linear-gradient(135deg, var(--ios-green), var(--ios-mint));
      color: white;
      padding: 120px 0 80px;
      text-align: center;
      border-radius: 0 0 24px 24px;
      margin-bottom: 40px;
    }
    
    .calc-header h1 {
      font-weight: 700;
      color: white;
      margin-bottom: 16px;
    }
    
    .calc-header p {
      font-size: 1.2rem;
      opacity: 0.9;
      max-width: 700px;
      margin: 0 auto;
    }
    
    .calculator-card {
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      background-color: var(--ios-system-background);
      margin-bottom: 30px;
    }
    
    .calculator-header {
      background-color: var(--ios-gray6);
      padding: 20px 24px;
      border-bottom: 1px solid var(--ios-gray5);
    }
    
    .calculator-header h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
    }
    
    .calculator-body {
      padding: 24px;
    }
    
    .result-card {
      background: linear-gradient(135deg, var(--ios-blue), var(--ios-indigo));
      color: white;
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      margin-top: 24px;
    }
    
    .result-card h3 {
      color: white;
      margin-bottom: 16px;
      font-weight: 700;
    }
    
    .result-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .result-unit {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .activity-card {
      background-color: var(--ios-gray6);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--ios-gray5);
    }
    
    .activity-card h4 {
      font-weight: 600;
      margin-bottom: 16px;
    }
  </style>
  <script>
    $(document).ready(function () {
      var token = localStorage.getItem('token')
      if (token) {
      } else {
        $('#userPoints').text('未登录')
        alert('请先登录。')
        window.location.href = 'index.html'
      }
      // 初始化活动小类选项
      updateActivityOptions($('#category').val())
      updateActivityOptions($('#category').val())
      calculateAndDisplayReduction() // 确保活动选项已填充
      $('#dataInput, #activity').on('input change', calculateAndDisplayReduction)
      $('#carbonForm').submit(function (e) {
        e.preventDefault()
        var uid = localStorage.getItem('id')
        var formData = new FormData(this)
        formData.append('activity', $('#activity').val())
        formData.append('oridata', $('#dataInput').val())
        formData.append('token', localStorage.getItem('token'))
        formData.append('id', uid)

        $.ajax({
          type: 'POST',
          url: 'calculate.php',
          data: formData,
          processData: false,
          contentType: false,
          dataType: 'json',
          success: function (response) {
            if (response.success === true) {
              // 提交成功，更新用户积分
              console.log('Carbon footprint recorded successfully. Carbon reduction: ' + response.points)
              $('#submissionResult').html('<div class="alert alert-success">Success! ' + response.points + ' points recorded!</div>')
              getUserPoints() // 更新用户积分显示
            } else {
              // 提交失败，显示错误消息
              console.error('Error recording carbon footprint:', response.message)
              $('#submissionResult').html('<div class="alert alert-danger">Error: ' + response.message + '</div>')
            }
          },
          error: function () {
            console.error('AJAX请求失败')
            $('#submissionResult').html('<div class="alert alert-danger">AJAX request failed.</div>')
          }
        })
      })

      // 活动大类改变时更新活动小类选项
      $('#category').change(function () {
        updateActivityOptions($(this).val())
      })

      // 获取用户积分
      getUserPoints()
    })

    // 更新活动小类选项的函数
    function updateActivityOptions(category) {
      // 清空当前选项
      $('#activity').empty()

      // 根据不同的活动大类添加相应的活动小类选项
      switch (category) {
        case 'transport':
          addOption('bus', 'Public Bus')
          addOption('subway', 'Subway')
          addOption('train', 'Train')
          addOption('walk', 'Walking')
          addOption('bike', 'Biking')
          addOption('evehicle', 'Electric Vehicle')
          break
        case 'energy':
          addOption('electricity_saved', 'Electricity Saved')
          addOption('gas_saved', 'Gas Saved')
          addOption('water_saved', 'Water Saved')
          break
        case 'food':
          addOption('vegetarian_meal', 'Vegetarian Meal')
          addOption('local_produce', 'Local Produce')
          addOption('reduce_waste', 'Reducing Food Waste')
          break
        case 'waste':
          addOption('recycle_paper', 'Recycling Paper')
          addOption('recycle_plastic', 'Recycling Plastic')
          addOption('recycle_metal', 'Recycling Metal')
          addOption('recycle_glass', 'Recycling Glass')
          addOption('compost', 'Composting')
          break
      }

      // 触发计算和显示减排量
      calculateAndDisplayReduction()
    }

    // 添加选项的辅助函数
    function addOption(value, text) {
      $('#activity').append($('<option></option>').val(value).text(text))
    }

    // 计算并显示减排量的函数
    function calculateAndDisplayReduction() {
      var activity = $('#activity').val()
      var dataValue = parseFloat($('#dataInput').val()) || 0

      // 减排系数（kg CO2 per unit）
      var reductionFactors = {
        // 交通方式（每公里减少的排放量，相比私家车）
        'bus': 0.1, // kg CO2 per km
        'subway': 0.12,
        'train': 0.08,
        'walk': 0.2,
        'bike': 0.2,
        'evehicle': 0.1,

        // 能源节约（每单位减少的排放量）
        'electricity_saved': 0.5, // kg CO2 per kWh
        'gas_saved': 0.2, // kg CO2 per cubic meter
        'water_saved': 0.5, // kg CO2 per cubic meter

        // 食品选择（每餐减少的排放量）
        'vegetarian_meal': 1.5, // kg CO2 per meal
        'local_produce': 0.5, // kg CO2 per kg of produce
        'reduce_waste': 1.0, // kg CO2 per kg of waste avoided

        // 废物管理（每公斤减少的排放量）
        'recycle_paper': 0.8, // kg CO2 per kg
        'recycle_plastic': 1.5,
        'recycle_metal': 4.0,
        'recycle_glass': 0.3,
        'compost': 0.5
      }

      // 单位标签
      var unitLabels = {
        // 交通方式
        'bus': 'km',
        'subway': 'km',
        'train': 'km',
        'walk': 'km',
        'bike': 'km',
        'evehicle': 'km',

        // 能源节约
        'electricity_saved': 'kWh',
        'gas_saved': 'm³',
        'water_saved': 'm³',

        // 食品选择
        'vegetarian_meal': 'meals',
        'local_produce': 'kg',
        'reduce_waste': 'kg',

        // 废物管理
        'recycle_paper': 'kg',
        'recycle_plastic': 'kg',
        'recycle_metal': 'kg',
        'recycle_glass': 'kg',
        'compost': 'kg'
      }

      // 计算减排量
      var reductionFactor = reductionFactors[activity] || 0
      var reductionAmount = dataValue * reductionFactor

      // 显示减排量和单位
      $('#unitLabel').text(unitLabels[activity] || 'units')
      $('#reductionAmount').text(reductionAmount.toFixed(2))
    }

    // 获取用户积分的函数
    function getUserPoints() {
      var uid = localStorage.getItem('id')
      var token = localStorage.getItem('token')

      // 发送AJAX请求获取用户积分
      $.ajax({
        type: 'POST',
        url: 'get_user_points.php',
        data: {
          uid: uid,
          token: token
        },
        dataType: 'json',
        success: function (response) {
          if (response.success) {
            $('#userPoints').text(response.points)
          } else {
            console.error('Error getting user points:', response.message)
          }
        },
        error: function () {
          console.error('AJAX请求失败')
        }
      })
    }
  </script>
</head>
<body>
<!-- 导航栏容器，将由JavaScript加载 -->
<div id="navbar-container"></div>

<header class="calc-header">
  <div class="container">
    <h1>Carbon Accounting Portal</h1>
    <p>Record your sustainable actions and track your positive impact on the environment. Every small action counts towards a greener future.</p>
  </div>
</header>

<div class="container">
  <div class="row">
    <div class="col-md-8">
      <div class="calculator-card frosted-glass ios-depth-effect">
        <div class="calculator-header">
          <h2>Carbon Reduction Calculator</h2>
        </div>
        <div class="calculator-body">
          <form id="carbonForm" method="post">
            <div class="form-group">
              <label for="category">Category</label>
              <select class="form-control" id="category" name="category">
                <option value="transport">Transportation</option>
                <option value="energy">Energy Saving</option>
                <option value="food">Food Choices</option>
                <option value="waste">Waste Management</option>
              </select>
            </div>
            <div class="form-group">
              <label for="activity">Activity</label>
              <select class="form-control" id="activity" name="activity">
                <!-- 将由JavaScript动态填充 -->
              </select>
            </div>
            <div class="form-group">
              <label for="dataInput">Quantity <span id="unitLabel">units</span></label>
              <input type="number" class="form-control" id="dataInput" name="data" placeholder="Enter amount" min="0" step="0.01">
            </div>
            <div class="form-group">
              <label for="date">Date</label>
              <input type="date" class="form-control" id="date" name="date" value="" required>
              <script>document.getElementById('date').valueAsDate = new Date()</script>
            </div>
            <div class="form-group">
              <label for="notes">Notes (Optional)</label>
              <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Add any additional notes here"></textarea>
            </div>
            <button type="submit" class="btn btn-ios-primary btn-block">Submit Carbon Reduction</button>
          </form>
          <div id="submissionResult" class="mt-3"></div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="result-card ios-hover-effect">
        <h3>Your Estimated Carbon Reduction</h3>
        <div class="result-value"><span id="reductionAmount">0.00</span></div>
        <p class="result-unit">kg CO₂ equivalent</p>
      </div>
      
      <div class="calculator-card mt-4">
        <div class="calculator-header">
          <h2>Your Account</h2>
        </div>
        <div class="calculator-body">
          <p><strong>Total Carbon Credits:</strong> <span id="userPoints">Loading...</span></p>
          <a href="center.html" class="btn btn-outline-primary btn-block">View Account History</a>
        </div>
      </div>
      
      <div class="activity-card mt-4">
        <h4>Environmental Impact</h4>
        <p>Every action you record helps reduce carbon emissions and contributes to a more sustainable future. Track your progress and see the difference you're making!</p>
      </div>
    </div>
  </div>
</div>

<!-- 页脚 -->
<div id="footer-placeholder"></div>
</body>
</html>
